---

title: Data Block

keywords: fastai
sidebar: home_sidebar

summary: "Primary handlers for interfacing the openai gym envs"
description: "Primary handlers for interfacing the openai gym envs"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_data_block.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset">Dataset<a class="anchor-link" href="#Dataset"> </a></h2><p><code>Dataset</code> instances are going to be a little different from the typically classification dataset that you might use in pytorch. Commonly, datasets have:</p>
<ul>
<li>A known size to iter through</li>
<li>Maintain their state during the training sequence</li>
<li>Randomly sample their dataset</li>
<li>Have a common <code>x</code>/<code>y</code> or <code>input</code>/<code>target</code> data format</li>
</ul>
<p>For our <a href="/fastrl/data_block#ExperienceSourceDataset"><code>ExperienceSourceDataset</code></a>, most of this is going to be different.</p>
<ul>
<li>We can have multiple sources (envs)</li>
</ul>
<p>You could think of a traditional dataset approach as being a mix of a <a href="/fastrl/data_block#ExperienceSourceDataset"><code>ExperienceSourceDataset</code></a> and a form of <code>ExperienceReplay</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Experience" class="doc_header"><code>class</code> <code>Experience</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L35" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Experience</code>(<strong><code>s</code></strong>:<code>array</code>, <strong><code>sp</code></strong>:<code>array</code>, <strong><code>a</code></strong>:<code>array</code>, <strong><code>r</code></strong>:<code>array</code>, <strong><code>d</code></strong>:<code>array</code>, <strong><code>agent_s</code></strong>:<code>array</code>)</p>
</blockquote>
<p>Experience(s: <built-in function array>, sp: <built-in function array>, a: <built-in function array>, r: <built-in function array>, d: <built-in function array>, agent_s: <built-in function array>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">exp</span><span class="o">=</span><span class="n">Experience</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)),</span>
               <span class="n">sp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)),</span>
               <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
               <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">)),</span>
               <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)),</span>
               <span class="n">agent_s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span>
<span class="n">asdict</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;s&#39;: array([[1, 1, 1, 2, 2],
        [1, 1, 1, 1, 1],
        [1, 2, 2, 1, 2],
        [2, 1, 1, 2, 2],
        [1, 1, 1, 2, 2]]),
 &#39;sp&#39;: array([[1, 1, 2, 1, 2],
        [2, 2, 2, 1, 1],
        [1, 1, 1, 1, 1],
        [2, 1, 1, 2, 2],
        [2, 1, 2, 2, 1]]),
 &#39;a&#39;: array([[1, 1]]),
 &#39;r&#39;: array([[2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 2, 2]]),
 &#39;d&#39;: array([[0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0]]),
 &#39;agent_s&#39;: array([[1, 3, 0, 2, 5]])}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Datasets">Datasets<a class="anchor-link" href="#Datasets"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We have a couple constraints on what the <a href="/fastrl/data_block#ExperienceSourceDataset"><code>ExperienceSourceDataset</code></a> is going to look like. For <code>__getitem__</code> it should return a tuple of 2 elements:</p>
<ul>
<li><code>xb</code> which are the elements that are going to be directly fed into the model for getting actions.</li>
<li><code>yb</code> which are all of the elements provided by the environment that we can use for training.</li>
</ul>
<p>Some semantics:</p>
<ul>
<li><code>iter</code> means what is returned from <code>next(dataset)</code> for farthur what is returned from <code>[o for o in dataset]</code>.</li>
<li><code>step</code> means an individual step in the env. You can have multiple steps per <code>iter</code>.</li>
<li><code>batch_size</code> is the same thing as <code>step</code>.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ExperienceSourceCallback" class="doc_header"><code>class</code> <code>ExperienceSourceCallback</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L53" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ExperienceSourceCallback</code>(<strong><code>learn</code></strong>) :: <code>LearnerCallback</code></p>
</blockquote>
<p>Base class for creating callbacks for a <code>Learner</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ExperienceSourceDataset" class="doc_header"><code>class</code> <code>ExperienceSourceDataset</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L60" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ExperienceSourceDataset</code>(<strong><code>env</code></strong>:<code>str</code>, <strong><code>n_envs</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>learn</code></strong>:<code>Optional</code>[<code>Learner</code>]=<em><code>None</code></em>, <strong><code>callback_fns</code></strong>:<code>List</code>[<code>LearnerCallback</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>skip_n_steps</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>max_steps</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>None</code></em>, <strong><code>pixels</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>per_env_d</code></strong>:<code>array</code>=<em><code>None</code></em>, <strong><code>per_env_s</code></strong>:<code>array</code>=<em><code>None</code></em>, <strong><code>per_env_steps</code></strong>:<code>array</code>=<em><code>None</code></em>, <strong><code>per_env_rewards</code></strong>:<code>array</code>=<em><code>None</code></em>, <strong><code>total_rewards</code></strong>:<code>List</code>[<code>T</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>total_steps</code></strong>:<code>List</code>[<code>T</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>_env_idx</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>_warned</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>_end_interation</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>_getitem_as_exp</code></strong>:<code>bool</code>=<em><code>False</code></em>) :: <code>IterableDataset</code></p>
</blockquote>
<p>Similar to fastai's <code>LabelList</code>, iters in-order samples from <code>1-&gt;len(envs)</code> <code>envs</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span><span class="o">=</span><span class="n">ExperienceSourceDataset</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">skip_n_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bs</span><span class="o">=</span><span class="mi">10</span>

<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_yb</span><span class="o">=</span><span class="kc">None</span>
<span class="n">data</span><span class="o">=</span><span class="p">[]</span>
<span class="n">yb_data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="n">final_yb</span><span class="o">=</span><span class="n">yb</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
    <span class="n">yb_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">final_yb</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># If there is more that 1 attempted batches, all the previous ones should be the correct size. The last one might be shorter</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">==</span><span class="n">bs</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[08-21 01:56:45] p22390 line:69 WARNING - `self.learn` is None. will use random actions instead.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span><span class="o">=</span><span class="n">ExperienceSourceDataset</span><span class="p">(</span><span class="s2">&quot;MountainCar-v0&quot;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">skip_n_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bs</span><span class="o">=</span><span class="mi">10</span>
<span class="n">mountain_car_steps</span><span class="o">=</span><span class="mi">200</span>

<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_yb</span><span class="o">=</span><span class="kc">None</span>
<span class="n">data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="n">final_yb</span><span class="o">=</span><span class="n">yb</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]),</span><span class="n">mountain_car_steps</span><span class="p">)</span>
<span class="c1"># assert bool(final_yb[&#39;d&#39;][-1]),final_yb[&#39;d&#39;][-1] MountainCar will likely not be done without some intervention.</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># If there is more that 1 attempted batches, all the previous ones should be the correct size. The last one might be shorter</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">==</span><span class="n">bs</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">r</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">pop_total_rewards</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="mi">200</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[08-21 01:56:48] p22390 line:69 WARNING - `self.learn` is None. will use random actions instead.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span><span class="o">=</span><span class="n">ExperienceSourceDataset</span><span class="p">(</span><span class="s2">&quot;MountainCar-v0&quot;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">skip_n_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">bs</span><span class="o">=</span><span class="mi">10</span>
<span class="n">mountain_car_steps</span><span class="o">=</span><span class="mi">200</span><span class="o">//</span><span class="mi">2</span> <span class="c1"># If we skip 2 steps, this should be 100</span>

<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_yb</span><span class="o">=</span><span class="kc">None</span>
<span class="n">data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="n">final_yb</span><span class="o">=</span><span class="n">yb</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]),</span><span class="n">mountain_car_steps</span><span class="p">)</span>
<span class="c1"># assert bool(final_yb[&#39;d&#39;][-1]),final_yb[&#39;d&#39;][-1] MountainCar will likely not be done without some intervention.</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># If there is more that 1 attempted batches, all the previous ones should be the correct size. The last one might be shorter</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">==</span><span class="n">bs</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">r</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">pop_total_rewards</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="mi">200</span><span class="p">)</span> <span class="c1"># r should still be -200</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[08-21 01:56:48] p22390 line:69 WARNING - `self.learn` is None. will use random actions instead.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span><span class="o">=</span><span class="n">ExperienceSourceDataset</span><span class="p">(</span><span class="s2">&quot;MountainCar-v0&quot;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">skip_n_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pixels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">bs</span><span class="o">=</span><span class="mi">10</span>
<span class="n">mountain_car_steps</span><span class="o">=</span><span class="mi">200</span>

<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_yb</span><span class="o">=</span><span class="kc">None</span>
<span class="n">data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="n">final_yb</span><span class="o">=</span><span class="n">yb</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

    
<span class="n">test_eq</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,(</span><span class="n">bs</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="mi">600</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]),</span><span class="n">mountain_car_steps</span><span class="p">)</span>
<span class="c1"># assert bool(final_yb[&#39;d&#39;][-1]),final_yb[&#39;d&#39;][-1] MountainCar will likely not be done without some intervention.</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># If there is more that 1 attempted batches, all the previous ones should be the correct size. The last one might be shorter</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">==</span><span class="n">bs</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">r</span><span class="p">,</span><span class="n">steps</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">pop_reward_steps</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="mi">200</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pop_reward_steps</span><span class="p">()),</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[08-21 01:56:50] p22390 line:69 WARNING - `self.learn` is None. will use random actions instead.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FirstLastExperienceSourceDataset" class="doc_header"><code>class</code> <code>FirstLastExperienceSourceDataset</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L203" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FirstLastExperienceSourceDataset</code>(<strong>*<code>args</code></strong>, <strong><code>discount</code></strong>=<em><code>0.99</code></em>, <strong><code>skip_n_steps</code></strong>=<em><code>1</code></em>, <strong>**<code>kwargs</code></strong>) :: <a href="/fastrl/data_block#ExperienceSourceDataset"><code>ExperienceSourceDataset</code></a></p>
</blockquote>
<p>Similar to <a href="/fastrl/data_block#ExperienceSourceDataset"><code>ExperienceSourceDataset</code></a> but only keeps the first and last parts of a step. Can be seen as frame skipping.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="n">ds</span><span class="o">=</span><span class="n">FirstLastExperienceSourceDataset</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">skip_n_steps</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">bs</span><span class="o">=</span><span class="mi">128</span>

<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_yb</span><span class="o">=</span><span class="kc">None</span>
<span class="n">data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">3.99</span><span class="p">,</span><span class="mf">0.1</span><span class="p">))</span>
    <span class="n">final_yb</span><span class="o">=</span><span class="n">yb</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># If there is more that 1 attempted batches, all the previous ones should be the correct size. The last one might be shorter</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">==</span><span class="n">bs</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-7-53fb5fc34de5&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     10</span>     <span class="ansi-green-fg">assert</span> len<span class="ansi-blue-fg">(</span>yb<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;s&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">&lt;=</span>bs
<span class="ansi-green-intense-fg ansi-bold">     11</span>     <span class="ansi-green-fg">assert</span> len<span class="ansi-blue-fg">(</span>yb<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;d&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">&lt;=</span>bs
<span class="ansi-green-fg">---&gt; 12</span><span class="ansi-red-fg">     </span>test_eq<span class="ansi-blue-fg">(</span>yb<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;r&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>pytest<span class="ansi-blue-fg">.</span>approx<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">3.99</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">0.1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     13</span>     final_yb<span class="ansi-blue-fg">=</span>yb
<span class="ansi-green-intense-fg ansi-bold">     14</span>     data<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>xb<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;test_eq&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span><span class="o">=</span><span class="n">FirstLastExperienceSourceDataset</span><span class="p">(</span><span class="s2">&quot;MountainCar-v0&quot;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">skip_n_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bs</span><span class="o">=</span><span class="mi">10</span>
<span class="n">mountain_car_steps</span><span class="o">=</span><span class="mi">200</span>

<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_yb</span><span class="o">=</span><span class="kc">None</span>
<span class="n">data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">bs</span>
    <span class="n">final_yb</span><span class="o">=</span><span class="n">yb</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]),</span><span class="n">mountain_car_steps</span><span class="p">)</span> <span class="c1"># Should be half since first last by default merges 2 steps</span>
<span class="c1"># assert bool(final_yb[&#39;d&#39;][-1]),final_yb[&#39;d&#39;][-1] MountainCar will likely not be done without some intervention.</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># If there is more that 1 attempted batches, all the previous ones should be the correct size. The last one might be shorter</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">==</span><span class="n">bs</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">r</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">pop_total_rewards</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="mi">200</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[08-21 01:56:52] p22390 line:69 WARNING - `self.learn` is None. will use random actions instead.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Experience-Dataset-Shower">Experience Dataset Shower<a class="anchor-link" href="#Experience-Dataset-Shower"> </a></h2><p>We can define a wrapper around a dataset which will show up to <code>rows * cols</code> environments.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DatasetDisplayWrapper" class="doc_header"><code>class</code> <code>DatasetDisplayWrapper</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L236" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DatasetDisplayWrapper</code>(<strong><code>ds</code></strong>, <strong><code>rows</code></strong>=<em><code>2</code></em>, <strong><code>cols</code></strong>=<em><code>2</code></em>, <strong><code>max_w</code></strong>=<em><code>800</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span><span class="o">=</span><span class="n">ExperienceSourceDataset</span><span class="p">(</span><span class="s2">&quot;MountainCar-v0&quot;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">skip_n_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">pixels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds</span><span class="o">=</span><span class="n">DatasetDisplayWrapper</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">800</span><span class="p">)</span>
<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span><span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAlgAAAGQCAIAAAD9V4nPAAANKElEQVR4nO3dWZbTyhZFUZlBj24DExpIm/w+zHMalyqiOBFnzq9bGuM0WmxJTk7n83kBgKx+9H4CANCTEAKQmhACkJoQApCaEAKQmhACkJoQApCaEAKQmhACkJoQApCaEAKQmhACkJoQApCaEAKQmhACkJoQApCaEAIQ1Ol0+vPn9OfPqeqP8rPqowPAcXct/O+/c8EHF0IABlO2i0IIwNgOdlEIAZjK1i66WQaA1CxCAKbi1CgAubhZBoBcfHwCgFzKlu/O6Xyu+OgAsNvp1CJS7hoFIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEIDUhBCA1IQQgNSEEILXT+Xzu/RwA4NvpdDr+IOvrJoQA9FQke2u86p0QAtBas/i9cts+IQSgke79e+pn7ycAwMx2xK/IQlv/41qEAFSxMkXNMvTq+QghACWt6V/39Nw+SSEEoIyPCYxZHNcIATjkff9ixu+WEAKw0+gJvBBCADZ7k8BR+nclhABsMFMCL4QQgFVeJXDQ/l0JIQAfzJrACyEE4J2nFZwjgRdCCMBz0yfwQggBuJckgRdCCMA/His4awIvhBCAv1INwSshBGBZ8g3BKyEEyC5tAi9+9H4CAPSUvIKLRQiQlgReWIQAGanglUUIkM5dBdMm8EIIARIxBB8JIUAWhuBTrhECpKCCrwghwPxU8A2nRgFmJoEfWYQA01LBNYQQYE4quJIQAkxIBddzjRBgKhK4lUUIMA8V3EEIASahgvsIIcAMVHA31wgBhndbQQncyiIEGJsKHiSEAANTweOEEGBUKliEEAIMSQVLcbMMwGDcIFqWRQgwEhUsTggBhqGCNQghwBhUsBLXCAEGI4FlWYQAI1HB4ixCgNB8TKI2ixAgLhVsQAgBglLBNoQQICIVbEYIAcJRwZaEECAWFWxMCAECUcH2hBAgChXsQggBQlDBXoQQoD8V7EgIATpTwb6EEIDUhBCgJ3OwOyEE6EYFIxBCgD5UMAghBOhABeMQQoDWVDAUIQRoSgWjEUKAdlQwICEEaEQFYxJCgBZUMCwhBKhOBSMTQgBSE0KAuszB4IQQoCIVjE8IAWpRwSEIIUAVKjgKIQQoTwUHIoQAhangWIQQoCQVHI4QApCaEAIUYw6OSAgBylDBQQkhQAEqOC4hBDhKBYcmhACHqODohBCA1P7+RsbvYgB2MAcn8HcR3n4tAVhDBefwfWpUCwHWU8Fp/Lj9+mkhwBoqOBM3ywBso4KT+bH8+4U0CgFI5e8i1EKANczB+XyfGtVCgPdUcEr/XCPUQoBXVHBWbpYB+EwFJ3YfQqMQgFSeLEItBLhlDs7t+alRLQS4UMHpvbxGqIUAKpiBm2UAnlPBJN6F0CgEYHofFqEWAjmZg3l8PjWqhUA2KpjKqmuEWgjkoYLZuFkGgNTWhtAoBDIwBxPasAi1EJibCua07dSoFgKzUsG0XCMEUMHUNofQKARgJnsWoRYCMzEHk9t5alQLgTmoIPuvEWohMDoVZHGzDADJHQqhUQiMyxzk4ugi1EJgRCrIVYFTo1oIjEUFueUaIQCplQmhUQiMwhzkTrFFqIVAfCrIo5KnRrUQiEwFeco1QgBSKxxCoxCIyRzklfKLUAuBaFSQN6qcGtVCIA4V5D3XCIGZqSAf1QqhUQjAECouQi0E+jIHWaPuqVEtBHpRQVZyjRCYkAqyXvUQGoUARNZiEWoh0JI5yCaNTo1qIdCGCrKVa4TAPFSQHdqF0CgEIKCmi1ALgXrMQfZpfWpUC4EaVJDdXCMEILUOITQKgbLMQY7oswi1EChFBTmo26lRLQSOU0GOc40QgNR6htAoBI4wBymi8yLUQmAfFaSU/qdGtRDYSgUpqH8IAaCjECE0CoH1zEHKChHCRQuBdVSQ4qKEcNFC4BMVpIZAIQSA9mKF0CgEXjEHqSRWCBctBJ5RQeoJF8JFC4F/qSBVRQwhADQTNIRGIXBhDlJb0BAuWgioIE3EDeGihZCbCtJG6BACQG3RQ2gUQk7mIM1ED+GihZCPCtLSACEEUlFBGhsjhEYhAJWMEcJFCyEHc5D2hgnhooUwOxWki5FCCExMBellsBAahQCUNVgIFy2EGZmDdDReCBcthLmoIH0NGUIAKGXUEBqFMAdzkO5GDeGihTA+FSSCgUO4aCGMTAUJYuwQAsBBw4fQKIQRmYPEMXwIFy2E0aggocwQwkULYRwqSDSThBAA9pknhEYhxGcOEtA8IVy0EGJTQWKaKoSLFkJUKkhYs4UQCEgFiWzCEBqFAKw3YQgXLYRIzEGCmzOEixZCDCpIfNOGEOhOBRnCzCE0CgH4aOYQLloI/ZiDjGLyEC5aCD2oIAOZP4SLFkJbKshYUoQQAF7JEkKjENowBxlOlhAuWgj1qSAjShTCRQuhJhVkULlCCAB30oXQKIQazEHGlS6EixZCaSrI0DKGcNFCKEcFGV3SEAJFqCATyBtCoxCAJXMIFy2EY8xB5pA6hIsWwl4qyDSyh3DRQthOBZmJEAKQmhAui1EIW5iDTEYI/9JCWEMFmY8QftNCeE8FmZIQ/kML4RUVZFZCCEBqQnjPKIRH5iATE8IntBBuqSBzE8LntBAuVJDpCeFLWggqSAZCCEBqQviOUUhm5iBJCOEHWkhOKkgeQviZFpKNCpKKEK6iheShgmQjhMA3FSQhIVzLKASYkhBuoIXMzRwkJyHcRguZlQqSlhBupoXMRwXJTAj30EJmooIkJ4SQmgqCEO5kFALMQQj300JGZw7CIoQHaSHjUkG4EMKjtJARqSBcCWEBWshYVBBuCWEZWsgoVBDuCCEAqQlhMUYh8ZmD8EgIS9JCIlNBeEoIC9NCYlJBeEUIy9NColFBeEMIq9BC4lBBeE8Ia9FCIlBB+EgIK9JC+lJBWEMI69JCelFBWEkIYUIqCOsJYXVGIUBkQtiCFtKSOQibCGEjWkgbKghbCWE7WkhtKgg7CGFTWkg9Kgj7CGFrWkgNKgi7CWEHWkhZKghHCGEfWkgpKggHCWE3WshxKgjHCWFPXVp4+r82Pxz1qCAUIYSdddyFcjg0FYRShLC/li18fHw5HJEKQkFCGEL364VyOBAVhLJOfiGFcj3G1fi6rEydt0RkKgjFWYRBddxn1mFYKgg1CGEs9c6Rbn00OYxGBaESIQyn+/XCW3IYxO05cxWEsoQwouItPPggctiXFx+qEsKgQu3CCznswhlRqE0I4yrVwuLXGuWwGRWEBoQwtIC78EIOG1BBaMPnCAdw5IDYIFfeQsXdfdW8wlCVRTiAu10YbYoFfEpDU0FozCIcxo7j4+3/8uvXr8f/4Ok/PMLb6SAVhPaEcCSbjpLX//hj7eQwCBWELpwaHcndkXHNCck1kSseQidLd7i7EqyC0IwQDubuEPmmN92PpFq4nhtEoSMhHNLKFq6fesVHIeupIPQlhKMKfivp4pi+wt0XzisGXQjhwHZcMnzDKGzMrTEQhBCOrWwLC3JYf08FIQ4hHF7YFvKKCkIoP3s/AQq4HEmvh9fLX2w9vK7/xP3Hk6iO7K9IIARkEc6j+CXDV8F78694QwUhJiGcyt2xdXeujnwM3/H9KRWEsIRwNvuOsF9fX76bSSWPH27xOkMovtfotNZ/r9Gvr6/bv/39+/f6H+Xuwb2d7kggxGcRTut6zH1/Se+ughSkgjAEd43O7Hw+P+7CX79+VYqfA/3V451KXhwIyyKc3OOVv/dnSjedF+WpxyGoghCZEKbw+MmKVx+u2D0WHesX98XAmIQwi8cjsu9BU5bToTAo1wgTufsGNMve70Hz6pHTkkAYmkWYTsFp6I7TpyeZVRDGIoQZPd6+cXtA35S3zHeCPE1g2lcDxuUD9ak93YKXt8TH20czz8E3rxswHCHk5WH9VQsl8I5fRDA0IWRZPh3fr0WUwDt++cAEhJBvjvWveGVgYkLIPQf9W14NmJ4Q8tyrz1QkecMk/+lDKkLIS28+Xzjx20YCIRsh5IM8OczzMwVuCSGrvP/uM0O/iyb+qQFrCCHbzDSbZvq5ALsJIXsMvaKGfvJAcULIfmu+W3eQN9hATxVoTAgpYOWfX9H4zRbzWQHRCCHFbP3jnIq/97o/AWBEQkh5u/+Aw6v3b8uDj+89D9wSQuo6HsUivM+BV4SQdhpH0XsbWEMI6aZ4F72ZgR2EkIh81A9oRggBSO1H7ycAAD0JIQCpCSEAqQkhAKkJIQCpCSEAqQkhAKkJIQCpCSEAqQkhAKkJIQCpCSEAqQkhAKkJIQCpCSEAqQkhAKkJIQCpCSEAqQkhAKkJIQCpCSEAqQkhAKkJIQCpCSEAqQkhAKkJIQCpCSEAqQkhAKkJIQCpCSEAqf0PoLQ3uJvxiKQAAAAASUVORK5CYII=
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="ExperienceSourceDataBunch">ExperienceSourceDataBunch<a class="anchor-link" href="#ExperienceSourceDataBunch"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ExperienceSourceDataBunch" class="doc_header"><code>class</code> <code>ExperienceSourceDataBunch</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L276" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ExperienceSourceDataBunch</code>(<strong><code>train_dl</code></strong>:<code>DataLoader</code>, <strong><code>valid_dl</code></strong>:<code>DataLoader</code>, <strong><code>fix_dl</code></strong>:<code>DataLoader</code>=<em><code>None</code></em>, <strong><code>test_dl</code></strong>:<code>Optional</code>[<code>DataLoader</code>]=<em><code>None</code></em>, <strong><code>device</code></strong>:<code>device</code>=<em><code>None</code></em>, <strong><code>dl_tfms</code></strong>:<code>Optional</code>[<code>Collection</code>[<code>Callable</code>]]=<em><code>None</code></em>, <strong><code>path</code></strong>:<code>Union</code>[<code>Path</code>, <code>str</code>]=<em><code>'.'</code></em>, <strong><code>collate_fn</code></strong>:<code>Callable</code>=<em><code>'data_collate'</code></em>, <strong><code>no_check</code></strong>:<code>bool</code>=<em><code>False</code></em>) :: <code>DataBunch</code></p>
</blockquote>
<p>Bind <code>train_dl</code>,<code>valid_dl</code> and <code>test_dl</code> in a data object.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">=</span><span class="n">ExperienceSourceDataBunch</span><span class="o">.</span><span class="n">from_env</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">firstlast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">add_valid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">train_dl</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">5</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[08-21 01:56:59] p22390 line:69 WARNING - `self.learn` is None. will use random actions instead.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">=</span><span class="n">ExperienceSourceDataBunch</span><span class="o">.</span><span class="n">from_env</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">firstlast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">add_valid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">train_dl</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">5</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Async-ExperienceSources">Async ExperienceSources<a class="anchor-link" href="#Async-ExperienceSources"> </a></h1><p>Async Experience sources have the challenge of running single process ExperienceSources in separate threads. Some questions are how rigid we want to make the actual fit look.</p>
<p>There are currently 2 ways to setup an Async dataset:</p>
<ul>
<li>Agent gets the data collected from the child processes. The model gets updated on the main thread which intern reflects in the child processes.</li>
<li>A sub learner runs inside each process and fits up until the back prop. Instead of doing back prop in the process, we collect the gradients and update them in the main thread. </li>
</ul>
<p>The first one is farely straight forward and only requires the model, the agent, and an uninstantiated Dataset.
The second is more complex. We basically have 2 fit procedures shared between the main process and the child processes.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="getattrsoftly" class="doc_header"><code>getattrsoftly</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L301" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>getattrsoftly</code>(<strong><code>o</code></strong>:<code>Optional</code>[<code>object</code>], <strong><code>name</code></strong>:<code>str</code>, <strong><code>default</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="arginpartial" class="doc_header"><code>arginpartial</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L302" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>arginpartial</code>(<strong><code>fn</code></strong>, <strong><code>arg_v</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="dequeuesoftly" class="doc_header"><code>dequeuesoftly</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L303" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>dequeuesoftly</code>(<strong><code>q</code></strong>:<code>Queue</code>, <strong><code>e</code></strong>:<code>Event</code>, <strong><code>n_attempts</code></strong>=<em><code>5</code></em>, <strong><code>warnings</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AsyncException" class="doc_header"><code>class</code> <code>AsyncException</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L322" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AsyncException</code>() :: <code>Exception</code></p>
</blockquote>
<p>Common base class for all non-exit exceptions.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AsyncExperienceSourceCallback" class="doc_header"><code>class</code> <code>AsyncExperienceSourceCallback</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L324" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AsyncExperienceSourceCallback</code>(<strong><code>learn</code></strong>) :: <code>LearnerCallback</code></p>
</blockquote>
<p>Base class for creating callbacks for a <code>Learner</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AsyncExperienceSourceDataset" class="doc_header"><code>class</code> <code>AsyncExperienceSourceDataset</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L371" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AsyncExperienceSourceDataset</code>(<strong><code>env</code></strong>:<code>str</code>, <strong><code>ds_cls</code></strong>:<code>type</code>, <strong><code>bs</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>1</code></em>, <strong><code>learn</code></strong>:<code>Optional</code>[<code>Learner</code>]=<em><code>None</code></em>, <strong><code>callback_fns</code></strong>:<code>List</code>[<code>LearnerCallback</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>n_processes</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>pause_event</code></strong>:<code>Event</code>=<em><code>&lt;multiprocessing.synchronize.Event object at 0x7fb1a0fbaa90&gt;</code></em>, <strong><code>cancel_event</code></strong>:<code>Event</code>=<em><code>&lt;multiprocessing.synchronize.Event object at 0x7fb1a0f530d0&gt;</code></em>, <strong><code>queue_sz</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>None</code></em>, <strong><code>main_queue</code></strong>:<code>Optional</code>[<code>JoinableQueue</code>]=<em><code>None</code></em>, <strong><code>metric_queue</code></strong>:<code>Optional</code>[<code>JoinableQueue</code>]=<em><code>None</code></em>, <strong><code>_proc_list</code></strong>:<code>List</code>[<code>Process</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>fitter_fn</code></strong>:<code>Optional</code>[<code>Callable</code>]=<em><code>None</code></em>, <strong><code>fitter_kwargs</code></strong>:<code>Dict</code>[<code>KT</code>, <code>VT</code>]=<em><code>None</code></em>, <strong><code>ds_kwargs</code></strong>:<code>Dict</code>[<code>KT</code>, <code>VT</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>learner_kwargs</code></strong>:<code>Dict</code>[<code>KT</code>, <code>VT</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>dequeue_warnings</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>dequeue_n_attempts</code></strong>:<code>int</code>=<em><code>50</code></em>) :: <code>Dataset</code></p>
</blockquote>
<p>AsyncExperienceSourceDataset(env: str, ds_cls: type, bs: Union[int, NoneType] = 1, learn: Union[fastai.basic_train.Learner, NoneType] = None, callback_fns: List[fastai.basic_train.LearnerCallback] = <factory>, n_processes: int = 1, pause_event: &lt;bound method BaseContext.Event of &lt;multiprocessing.context.DefaultContext object at 0x7fb2077ddf10&gt;&gt; = &lt;multiprocessing.synchronize.Event object at 0x7fb1a0fbaa90&gt;, cancel_event: &lt;bound method BaseContext.Event of &lt;multiprocessing.context.DefaultContext object at 0x7fb2077ddf10&gt;&gt; = &lt;multiprocessing.synchronize.Event object at 0x7fb1a0f530d0&gt;, queue_sz: Union[int, NoneType] = None, main_queue: Union[&lt;bound method BaseContext.JoinableQueue of &lt;multiprocessing.context.DefaultContext object at 0x7fb2077ddf10&gt;&gt;, NoneType] = None, metric_queue: Union[&lt;bound method BaseContext.JoinableQueue of &lt;multiprocessing.context.DefaultContext object at 0x7fb2077ddf10&gt;&gt;, NoneType] = None, _proc_list: List[multiprocessing.context.Process] = <factory>, fitter_fn: Union[Callable, NoneType] = None, fitter_kwargs: Dict = None, ds_kwargs: Dict = <factory>, learner_kwargs: Dict = <factory>, dequeue_warnings: bool = False, dequeue_n_attempts: int = 50)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastrl.basic_train</span> <span class="kn">import</span> <span class="n">AgentLearner</span>
<span class="kn">from</span> <span class="nn">fastcore.test</span> <span class="kn">import</span> <span class="n">test_eq</span>

<span class="n">bs</span><span class="o">=</span><span class="mi">4</span>

<span class="k">class</span> <span class="nc">FakeRunCallback</span><span class="p">(</span><span class="n">LearnerCallback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_backward_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;skip_bwd&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;skip_validate&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
    <span class="k">def</span> <span class="nf">on_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">last_target</span><span class="p">,</span><span class="n">last_input</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_target</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]),</span><span class="n">bs</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">last_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bs</span><span class="p">)</span>

<span class="n">ds</span><span class="o">=</span><span class="n">AsyncExperienceSourceDataset</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">ExperienceSourceDataset</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">n_processes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">dequeue_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ds_empty</span><span class="o">=</span><span class="n">AsyncExperienceSourceDataset</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">ExperienceSourceDataset</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_processes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dequeue_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dl_empty</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_empty</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span><span class="o">=</span><span class="n">DataBunch</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">dl_empty</span><span class="p">)</span>

<span class="n">model</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">agent</span><span class="o">=</span><span class="n">DQNAgent</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
<span class="n">learn</span><span class="o">=</span><span class="n">AgentLearner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span><span class="n">callback_fns</span><span class="o">=</span><span class="p">[</span><span class="n">FakeRunCallback</span><span class="p">])</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">wd</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.500000</td>
      <td>#na#</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bs</span><span class="o">=</span><span class="mi">40</span>
<span class="n">ds</span><span class="o">=</span><span class="n">AsyncExperienceSourceDataset</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">ExperienceSourceDataset</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">n_processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dequeue_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">batch_shapes</span><span class="o">=</span><span class="p">[]</span>
<span class="n">full_data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">with</span> <span class="n">ds</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
        <span class="n">batch_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">full_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">&gt;</span><span class="n">bs</span><span class="p">:</span><span class="k">raise</span> <span class="n">AsyncException</span><span class="p">(</span><span class="s1">&#39;batch_shapes should not be larger than the `ds.bs`*`ds.max_steps`&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">&gt;</span><span class="n">bs</span><span class="p">:</span><span class="k">raise</span> <span class="n">AsyncException</span><span class="p">(</span><span class="s1">&#39;batch_shapes should not be larger than the `ds.bs`&#39;</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">bs</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bs</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">bs</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">dict</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[08-21 02:06:04] p22390 line:105 WARNING - `self.learn` is None. Async&#39;s ds_cls will likely use random actions.
[08-21 02:06:04] p22548 line:69 WARNING - `self.learn` is None. will use random actions instead.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastrl.basic_train</span> <span class="kn">import</span> <span class="n">AgentLearner</span>
<span class="kn">from</span> <span class="nn">fastcore.test</span> <span class="kn">import</span> <span class="n">test_eq</span>
<span class="n">bs</span><span class="o">=</span><span class="mi">90</span>

<span class="k">class</span> <span class="nc">AlwaysDiscreteRight</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AlwaysDiscreteRight</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FloatTensor</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]])</span>
    
<span class="k">class</span> <span class="nc">AlwaysDiscreteLeft</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AlwaysDiscreteLeft</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FloatTensor</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.1</span><span class="p">]])</span>
    
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AlwaysDiscreteRight</span><span class="p">(),</span><span class="n">AlwaysDiscreteLeft</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Testing action: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">a</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">=</span><span class="n">AsyncExperienceSourceDataset</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">ExperienceSourceDataset</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">n_processes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">dequeue_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">model</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">m</span><span class="p">)</span>
    <span class="n">agent</span><span class="o">=</span><span class="n">DQNAgent</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">learn</span><span class="o">=</span><span class="n">AgentLearner</span><span class="p">(</span><span class="n">DataBunch</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">dl</span><span class="p">),</span><span class="n">model</span><span class="p">,</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">learn</span><span class="o">=</span><span class="n">learn</span>

    <span class="n">batch_shapes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">full_data</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">with</span> <span class="n">ds</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
            <span class="n">batch_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">full_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">yb</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">)</span><span class="o">&gt;</span><span class="n">bs</span><span class="p">:</span><span class="k">raise</span> <span class="n">AsyncException</span><span class="p">(</span><span class="s1">&#39;batch_shapes should not be larger than the `ds.bs`*`ds.max_steps`&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">bs</span><span class="p">:</span><span class="k">raise</span> <span class="n">AsyncException</span><span class="p">(</span><span class="s1">&#39;batch_shapes should not be larger than the `ds.bs`&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">full_data</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">==</span><span class="n">bs</span><span class="p">),</span><span class="s1">&#39;Dones are not being returned&#39;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">all</span><span class="p">([</span><span class="n">a</span><span class="o">==</span><span class="n">m</span><span class="o">.</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">full_data</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">full_data</span><span class="p">),</span><span class="n">bs</span><span class="p">)</span>
    <span class="n">full_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">batch_shapes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Testing action: 1
Testing action: 0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AsyncGradExperienceSourceDataset" class="doc_header"><code>class</code> <code>AsyncGradExperienceSourceDataset</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L504" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AsyncGradExperienceSourceDataset</code>(<strong><code>env</code></strong>:<code>str</code>, <strong><code>ds_cls</code></strong>:<code>type</code>, <strong><code>bs</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>1</code></em>, <strong><code>learn</code></strong>:<code>Optional</code>[<code>Learner</code>]=<em><code>None</code></em>, <strong><code>callback_fns</code></strong>:<code>List</code>[<code>LearnerCallback</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>n_processes</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>pause_event</code></strong>:<code>Event</code>=<em><code>&lt;multiprocessing.synchronize.Event object at 0x7fb1a0fbaa90&gt;</code></em>, <strong><code>cancel_event</code></strong>:<code>Event</code>=<em><code>&lt;multiprocessing.synchronize.Event object at 0x7fb1a0f530d0&gt;</code></em>, <strong><code>queue_sz</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>None</code></em>, <strong><code>main_queue</code></strong>:<code>Optional</code>[<code>JoinableQueue</code>]=<em><code>None</code></em>, <strong><code>metric_queue</code></strong>:<code>Optional</code>[<code>JoinableQueue</code>]=<em><code>None</code></em>, <strong><code>_proc_list</code></strong>:<code>List</code>[<code>Process</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>fitter_fn</code></strong>:<code>Optional</code>[<code>Callable</code>]=<em><code>None</code></em>, <strong><code>fitter_kwargs</code></strong>:<code>Dict</code>[<code>KT</code>, <code>VT</code>]=<em><code>None</code></em>, <strong><code>ds_kwargs</code></strong>:<code>Dict</code>[<code>KT</code>, <code>VT</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>learner_kwargs</code></strong>:<code>Dict</code>[<code>KT</code>, <code>VT</code>]=<em><code>&lt;factory&gt;</code></em>, <strong><code>dequeue_warnings</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>dequeue_n_attempts</code></strong>:<code>int</code>=<em><code>50</code></em>) :: <a href="/fastrl/data_block#AsyncExperienceSourceDataset"><code>AsyncExperienceSourceDataset</code></a></p>
</blockquote>
<p>The <a href="/fastrl/data_block#AsyncGradExperienceSourceDataset"><code>AsyncGradExperienceSourceDataset</code></a> class is instantiated via
passing          the <code>env_name</code> that we want to train on, and a
<code>partial</code> class of a <a href="/fastrl/data_block#ExperienceSourceDataset"><code>ExperienceSourceDataset</code></a> called <code>ds_cls</code>.
<code>bs</code> is a field here since the length of the dataset is not
necessarily the length of an episode. If <code>None</code> it will be the length
of a single episode of the environment. Agents such as A3C will likely
change this.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">FakeRunCallback</span><span class="p">(</span><span class="n">LearnerCallback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_backward_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;skip_bwd&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;skip_validate&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
    
<span class="n">bs</span><span class="o">=</span><span class="mi">40</span>

<span class="n">ds</span><span class="o">=</span><span class="n">AsyncGradExperienceSourceDataset</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">ExperienceSourceDataset</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">n_processes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">dequeue_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ds_empty</span><span class="o">=</span><span class="n">AsyncGradExperienceSourceDataset</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">ExperienceSourceDataset</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_processes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dequeue_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dl_empty</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_empty</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span><span class="o">=</span><span class="n">DataBunch</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">dl_empty</span><span class="p">)</span>

<span class="n">model</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">agent</span><span class="o">=</span><span class="n">DQNAgent</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
<span class="n">learn</span><span class="o">=</span><span class="n">AgentLearner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span><span class="n">callback_fns</span><span class="o">=</span><span class="p">[</span><span class="n">FakeRunCallback</span><span class="p">])</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">wd</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bs</span><span class="o">=</span><span class="mi">40</span>
<span class="n">ds</span><span class="o">=</span><span class="n">AsyncGradExperienceSourceDataset</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">ExperienceSourceDataset</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">n_processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dequeue_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">batch_shapes</span><span class="o">=</span><span class="p">[]</span>
<span class="n">full_data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">with</span> <span class="n">ds</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
        <span class="n">batch_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">full_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">&gt;</span><span class="n">bs</span><span class="p">:</span><span class="k">raise</span> <span class="n">AsyncException</span><span class="p">(</span><span class="s1">&#39;batch_shapes should not be larger than the `ds.bs`*`ds.max_steps`&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">&gt;</span><span class="n">bs</span><span class="p">:</span><span class="k">raise</span> <span class="n">AsyncException</span><span class="p">(</span><span class="s1">&#39;batch_shapes should not be larger than the `ds.bs`&#39;</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">bs</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bs</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">bs</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">list</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AsyncExperienceSourceDataBunch" class="doc_header"><code>class</code> <code>AsyncExperienceSourceDataBunch</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data_block.py#L523" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AsyncExperienceSourceDataBunch</code>(<strong><code>train_dl</code></strong>:<code>DataLoader</code>, <strong><code>valid_dl</code></strong>:<code>DataLoader</code>, <strong><code>fix_dl</code></strong>:<code>DataLoader</code>=<em><code>None</code></em>, <strong><code>test_dl</code></strong>:<code>Optional</code>[<code>DataLoader</code>]=<em><code>None</code></em>, <strong><code>device</code></strong>:<code>device</code>=<em><code>None</code></em>, <strong><code>dl_tfms</code></strong>:<code>Optional</code>[<code>Collection</code>[<code>Callable</code>]]=<em><code>None</code></em>, <strong><code>path</code></strong>:<code>Union</code>[<code>Path</code>, <code>str</code>]=<em><code>'.'</code></em>, <strong><code>collate_fn</code></strong>:<code>Callable</code>=<em><code>'data_collate'</code></em>, <strong><code>no_check</code></strong>:<code>bool</code>=<em><code>False</code></em>) :: <a href="/fastrl/data_block#ExperienceSourceDataBunch"><code>ExperienceSourceDataBunch</code></a></p>
</blockquote>
<p>Bind <code>train_dl</code>,<code>valid_dl</code> and <code>test_dl</code> in a data object.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span>
<span class="n">data</span><span class="o">=</span><span class="n">AsyncExperienceSourceDataBunch</span><span class="o">.</span><span class="n">from_env</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>

<span class="n">batch_shapes</span><span class="o">=</span><span class="p">[]</span>
<span class="n">full_data</span><span class="o">=</span><span class="p">[]</span>
<span class="k">with</span> <span class="n">data</span><span class="o">.</span><span class="n">train_ds</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">train_dl</span><span class="p">:</span>
        <span class="n">batch_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">full_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">)</span><span class="o">&gt;</span><span class="n">bs</span><span class="p">:</span><span class="k">raise</span> <span class="n">AsyncException</span><span class="p">(</span><span class="s1">&#39;batch_shapes should not be larger than `bs`&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">bs</span><span class="p">:</span><span class="k">raise</span> <span class="n">AsyncException</span><span class="p">(</span><span class="s1">&#39;batch_shapes should not be larger than `bs`&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">=</span><span class="n">AsyncExperienceSourceDataBunch</span><span class="o">.</span><span class="n">from_env</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">agent</span><span class="o">=</span><span class="n">DQNAgent</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
<span class="n">AgentLearner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span><span class="n">callback_fns</span><span class="o">=</span><span class="p">[</span><span class="n">FakeRunCallback</span><span class="p">])</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">wd</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">=</span><span class="n">AsyncExperienceSourceDataBunch</span><span class="o">.</span><span class="n">from_env</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">use_grad_experience</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">AgentLearner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span><span class="n">callback_fns</span><span class="o">=</span><span class="p">[</span><span class="n">FakeRunCallback</span><span class="p">])</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">wd</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">=</span><span class="n">AsyncExperienceSourceDataBunch</span><span class="o">.</span><span class="n">from_env</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">use_grad_experience</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ds_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;skip_n_steps&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">})</span>
<span class="n">AgentLearner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span><span class="n">callback_fns</span><span class="o">=</span><span class="p">[</span><span class="n">FakeRunCallback</span><span class="p">])</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">wd</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

