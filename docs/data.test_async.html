---

title: Async Testing


keywords: fastai
sidebar: home_sidebar

summary: "Testing async environment execution in a separate notebook."
description: "Testing async environment execution in a separate notebook."
nb_path: "nbs/05_data.test_async.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_data.test_async.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>One of the most important things to have working with the datablock is to answer:</p>

<pre><code>Can we run multiple envs, in multiple workers, using a torch Module, all loaded on cuda?

</code></pre>
<p>You can however there are some important things to use in your notebook.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include important.html content='This is only important if you are training with <code>num_workers&gt;0</code> and <code>str(default_device())==&amp;#8217;cuda&amp;#8217;</code>. If one of these is not true, then feel free' %}to train your model the <em>normal</em> way.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Relevant links:</p>
<p><a href="https://github.com/pytorch/pytorch/issues/37377">setting the <code>MKL_THREADING_LAYER</code> variable</a></p>
<p><a href="https://stackoverflow.com/questions/48822463/how-to-use-pytorch-multiprocessing">handling <code>set_start_method('spawn')</code></a></p>
<p><a href="https://github.com/pytorch/pytorch/issues/3492">using <code>if __name__ == '__main__'</code></a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.load</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span><span class="n">_FakeLoader</span><span class="p">,</span><span class="n">multiprocessing</span><span class="p">,</span><span class="n">_MultiProcessingDataLoaderIter</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data._utils</span> <span class="kn">import</span> <span class="n">worker</span> <span class="k">as</span> <span class="n">z</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>z<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre><span class="ansi-red-fg">Type:</span>        module
<span class="ansi-red-fg">String form:</span> &lt;module &#39;torch.utils.data._utils.worker&#39; from &#39;/opt/conda/lib/python3.7/site-packages/torch/utils/data/_utils/worker.py&#39;&gt;
<span class="ansi-red-fg">File:</span>        /opt/conda/lib/python3.7/site-packages/torch/utils/data/_utils/worker.py
<span class="ansi-red-fg">Source:</span>     
<span class="ansi-blue-fg">r&#34;&#34;&#34;&#34;Contains definitions of the methods used by the _BaseDataLoaderIter workers.</span>

<span class="ansi-blue-fg">These **needs** to be in global scope since Py2 doesn&#39;t support serializing</span>
<span class="ansi-blue-fg">static methods.</span>
<span class="ansi-blue-fg">&#34;&#34;&#34;</span>

<span class="ansi-green-fg">import</span> torch
<span class="ansi-green-fg">import</span> random
<span class="ansi-green-fg">import</span> os
<span class="ansi-green-fg">from</span> collections <span class="ansi-green-fg">import</span> namedtuple
<span class="ansi-green-fg">from</span> torch<span class="ansi-blue-fg">.</span>_six <span class="ansi-green-fg">import</span> queue
<span class="ansi-green-fg">from</span> torch<span class="ansi-blue-fg">.</span>_utils <span class="ansi-green-fg">import</span> ExceptionWrapper
<span class="ansi-green-fg">from</span> typing <span class="ansi-green-fg">import</span> Union
<span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> signal_handling<span class="ansi-blue-fg">,</span> MP_STATUS_CHECK_INTERVAL<span class="ansi-blue-fg">,</span> IS_WINDOWS

<span class="ansi-green-fg">if</span> IS_WINDOWS<span class="ansi-blue-fg">:</span>
    <span class="ansi-green-fg">import</span> ctypes
    <span class="ansi-green-fg">from</span> ctypes<span class="ansi-blue-fg">.</span>wintypes <span class="ansi-green-fg">import</span> DWORD<span class="ansi-blue-fg">,</span> BOOL<span class="ansi-blue-fg">,</span> HANDLE

    <span class="ansi-red-fg"># On Windows, the parent ID of the worker process remains unchanged when the manager process</span>
    <span class="ansi-red-fg"># is gone, and the only way to check it through OS is to let the worker have a process handle</span>
    <span class="ansi-red-fg"># of the manager and ask if the process status has changed.</span>
    <span class="ansi-green-fg">class</span> ManagerWatchdog<span class="ansi-blue-fg">(</span>object<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            self<span class="ansi-blue-fg">.</span>manager_pid <span class="ansi-blue-fg">=</span> os<span class="ansi-blue-fg">.</span>getppid<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

            <span class="ansi-red-fg"># mypy cannot detect this code is windows only</span>
            self<span class="ansi-blue-fg">.</span>kernel32 <span class="ansi-blue-fg">=</span> ctypes<span class="ansi-blue-fg">.</span>WinDLL<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;kernel32&#39;</span><span class="ansi-blue-fg">,</span> use_last_error<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>  <span class="ansi-red-fg"># type: ignore</span>
            self<span class="ansi-blue-fg">.</span>kernel32<span class="ansi-blue-fg">.</span>OpenProcess<span class="ansi-blue-fg">.</span>argtypes <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>DWORD<span class="ansi-blue-fg">,</span> BOOL<span class="ansi-blue-fg">,</span> DWORD<span class="ansi-blue-fg">)</span>
            self<span class="ansi-blue-fg">.</span>kernel32<span class="ansi-blue-fg">.</span>OpenProcess<span class="ansi-blue-fg">.</span>restype <span class="ansi-blue-fg">=</span> HANDLE
            self<span class="ansi-blue-fg">.</span>kernel32<span class="ansi-blue-fg">.</span>WaitForSingleObject<span class="ansi-blue-fg">.</span>argtypes <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>HANDLE<span class="ansi-blue-fg">,</span> DWORD<span class="ansi-blue-fg">)</span>
            self<span class="ansi-blue-fg">.</span>kernel32<span class="ansi-blue-fg">.</span>WaitForSingleObject<span class="ansi-blue-fg">.</span>restype <span class="ansi-blue-fg">=</span> DWORD

            <span class="ansi-red-fg"># Value obtained from https://msdn.microsoft.com/en-us/library/ms684880.aspx</span>
            SYNCHRONIZE <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0x00100000</span>
            self<span class="ansi-blue-fg">.</span>manager_handle <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>kernel32<span class="ansi-blue-fg">.</span>OpenProcess<span class="ansi-blue-fg">(</span>SYNCHRONIZE<span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>manager_pid<span class="ansi-blue-fg">)</span>

            <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>manager_handle<span class="ansi-blue-fg">:</span>
                <span class="ansi-green-fg">raise</span> ctypes<span class="ansi-blue-fg">.</span>WinError<span class="ansi-blue-fg">(</span>ctypes<span class="ansi-blue-fg">.</span>get_last_error<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>  <span class="ansi-red-fg"># type: ignore</span>

            self<span class="ansi-blue-fg">.</span>manager_dead <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>

        <span class="ansi-green-fg">def</span> is_alive<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>manager_dead<span class="ansi-blue-fg">:</span>
                <span class="ansi-red-fg"># Value obtained from https://msdn.microsoft.com/en-us/library/windows/desktop/ms687032.aspx</span>
                self<span class="ansi-blue-fg">.</span>manager_dead <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>kernel32<span class="ansi-blue-fg">.</span>WaitForSingleObject<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>manager_handle<span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">==</span> <span class="ansi-cyan-fg">0</span>
            <span class="ansi-green-fg">return</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>manager_dead
<span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-green-fg">class</span> ManagerWatchdog<span class="ansi-blue-fg">(</span>object<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>  <span class="ansi-red-fg"># type: ignore[no-redef]</span>
        <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            self<span class="ansi-blue-fg">.</span>manager_pid <span class="ansi-blue-fg">=</span> os<span class="ansi-blue-fg">.</span>getppid<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
            self<span class="ansi-blue-fg">.</span>manager_dead <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>

        <span class="ansi-green-fg">def</span> is_alive<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>manager_dead<span class="ansi-blue-fg">:</span>
                self<span class="ansi-blue-fg">.</span>manager_dead <span class="ansi-blue-fg">=</span> os<span class="ansi-blue-fg">.</span>getppid<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">!=</span> self<span class="ansi-blue-fg">.</span>manager_pid
            <span class="ansi-green-fg">return</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>manager_dead

_worker_info <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>


<span class="ansi-green-fg">class</span> WorkerInfo<span class="ansi-blue-fg">(</span>object<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    __initialized <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>

    <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">for</span> k<span class="ansi-blue-fg">,</span> v <span class="ansi-green-fg">in</span> kwargs<span class="ansi-blue-fg">.</span>items<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            setattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> k<span class="ansi-blue-fg">,</span> v<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>__keys <span class="ansi-blue-fg">=</span> tuple<span class="ansi-blue-fg">(</span>kwargs<span class="ansi-blue-fg">.</span>keys<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>__initialized <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span>

    <span class="ansi-green-fg">def</span> __setattr__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> key<span class="ansi-blue-fg">,</span> val<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>__initialized<span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">raise</span> RuntimeError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;Cannot assign attributes to {} objects&#34;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>__class__<span class="ansi-blue-fg">.</span>__name__<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> super<span class="ansi-blue-fg">(</span>WorkerInfo<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__setattr__<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">,</span> val<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> __repr__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        items <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>
        <span class="ansi-green-fg">for</span> k <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>__keys<span class="ansi-blue-fg">:</span>
            items<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;{}={}&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>k<span class="ansi-blue-fg">,</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> k<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> <span class="ansi-blue-fg">&#39;{}({})&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>__class__<span class="ansi-blue-fg">.</span>__name__<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;, &#39;</span><span class="ansi-blue-fg">.</span>join<span class="ansi-blue-fg">(</span>items<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>


<span class="ansi-green-fg">def</span> get_worker_info<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">r&#34;&#34;&#34;Returns the information about the current</span>
<span class="ansi-blue-fg">    :class:`~torch.utils.data.DataLoader` iterator worker process.</span>

<span class="ansi-blue-fg">    When called in a worker, this returns an object guaranteed to have the</span>
<span class="ansi-blue-fg">    following attributes:</span>

<span class="ansi-blue-fg">    * :attr:`id`: the current worker id.</span>
<span class="ansi-blue-fg">    * :attr:`num_workers`: the total number of workers.</span>
<span class="ansi-blue-fg">    * :attr:`seed`: the random seed set for the current worker. This value is</span>
<span class="ansi-blue-fg">      determined by main process RNG and the worker id. See</span>
<span class="ansi-blue-fg">      :class:`~torch.utils.data.DataLoader`&#39;s documentation for more details.</span>
<span class="ansi-blue-fg">    * :attr:`dataset`: the copy of the dataset object in **this** process. Note</span>
<span class="ansi-blue-fg">      that this will be a different object in a different process than the one</span>
<span class="ansi-blue-fg">      in the main process.</span>

<span class="ansi-blue-fg">    When called in the main process, this returns ``None``.</span>

<span class="ansi-blue-fg">    .. note::</span>
<span class="ansi-blue-fg">       When used in a :attr:`worker_init_fn` passed over to</span>
<span class="ansi-blue-fg">       :class:`~torch.utils.data.DataLoader`, this method can be useful to</span>
<span class="ansi-blue-fg">       set up each worker process differently, for instance, using ``worker_id``</span>
<span class="ansi-blue-fg">       to configure the ``dataset`` object to only read a specific fraction of a</span>
<span class="ansi-blue-fg">       sharded dataset, or use ``seed`` to seed other libraries used in dataset</span>
<span class="ansi-blue-fg">       code (e.g., NumPy).</span>
<span class="ansi-blue-fg">    &#34;&#34;&#34;</span>
    <span class="ansi-green-fg">return</span> _worker_info


<span class="ansi-blue-fg">r&#34;&#34;&#34;Dummy class used to signal the end of an IterableDataset&#34;&#34;&#34;</span>
_IterableDatasetStopIteration <span class="ansi-blue-fg">=</span> namedtuple<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;_IterableDatasetStopIteration&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;worker_id&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>

<span class="ansi-blue-fg">r&#34;&#34;&#34;Dummy class used to resume the fetching when worker reuse is enabled&#34;&#34;&#34;</span>
_ResumeIteration <span class="ansi-blue-fg">=</span> namedtuple<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;_ResumeIteration&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">def</span> _worker_loop<span class="ansi-blue-fg">(</span>dataset_kind<span class="ansi-blue-fg">,</span> dataset<span class="ansi-blue-fg">,</span> index_queue<span class="ansi-blue-fg">,</span> data_queue<span class="ansi-blue-fg">,</span> done_event<span class="ansi-blue-fg">,</span>
                 auto_collation<span class="ansi-blue-fg">,</span> collate_fn<span class="ansi-blue-fg">,</span> drop_last<span class="ansi-blue-fg">,</span> seed<span class="ansi-blue-fg">,</span> init_fn<span class="ansi-blue-fg">,</span> worker_id<span class="ansi-blue-fg">,</span>
                 num_workers<span class="ansi-blue-fg">,</span> persistent_workers<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-red-fg"># See NOTE [ Data Loader Multiprocessing Shutdown Logic ] for details on the</span>
    <span class="ansi-red-fg"># logic of this function.</span>

    <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-red-fg"># Initialize C side signal handlers for SIGBUS and SIGSEGV. Python signal</span>
        <span class="ansi-red-fg"># module&#39;s handlers are executed after Python returns from C low-level</span>
        <span class="ansi-red-fg"># handlers, likely when the same fatal signal had already happened</span>
        <span class="ansi-red-fg"># again.</span>
        <span class="ansi-red-fg"># https://docs.python.org/3/library/signal.html#execution-of-python-signal-handlers</span>
        signal_handling<span class="ansi-blue-fg">.</span>_set_worker_signal_handlers<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

        torch<span class="ansi-blue-fg">.</span>set_num_threads<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
        random<span class="ansi-blue-fg">.</span>seed<span class="ansi-blue-fg">(</span>seed<span class="ansi-blue-fg">)</span>
        torch<span class="ansi-blue-fg">.</span>manual_seed<span class="ansi-blue-fg">(</span>seed<span class="ansi-blue-fg">)</span>

        <span class="ansi-green-fg">global</span> _worker_info
        _worker_info <span class="ansi-blue-fg">=</span> WorkerInfo<span class="ansi-blue-fg">(</span>id<span class="ansi-blue-fg">=</span>worker_id<span class="ansi-blue-fg">,</span> num_workers<span class="ansi-blue-fg">=</span>num_workers<span class="ansi-blue-fg">,</span>
                                  seed<span class="ansi-blue-fg">=</span>seed<span class="ansi-blue-fg">,</span> dataset<span class="ansi-blue-fg">=</span>dataset<span class="ansi-blue-fg">)</span>

        <span class="ansi-green-fg">from</span> torch<span class="ansi-blue-fg">.</span>utils<span class="ansi-blue-fg">.</span>data <span class="ansi-green-fg">import</span> _DatasetKind

        init_exception <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>

        <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">if</span> init_fn <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
                init_fn<span class="ansi-blue-fg">(</span>worker_id<span class="ansi-blue-fg">)</span>

            fetcher <span class="ansi-blue-fg">=</span> _DatasetKind<span class="ansi-blue-fg">.</span>create_fetcher<span class="ansi-blue-fg">(</span>dataset_kind<span class="ansi-blue-fg">,</span> dataset<span class="ansi-blue-fg">,</span> auto_collation<span class="ansi-blue-fg">,</span> collate_fn<span class="ansi-blue-fg">,</span> drop_last<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">except</span> Exception<span class="ansi-blue-fg">:</span>
            init_exception <span class="ansi-blue-fg">=</span> ExceptionWrapper<span class="ansi-blue-fg">(</span>
                where<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#34;in DataLoader worker process {}&#34;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>worker_id<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

        <span class="ansi-red-fg"># When using Iterable mode, some worker can exit earlier than others due</span>
        <span class="ansi-red-fg"># to the IterableDataset behaving differently for different workers.</span>
        <span class="ansi-red-fg"># When such things happen, an `_IterableDatasetStopIteration` object is</span>
        <span class="ansi-red-fg"># sent over to the main process with the ID of this worker, so that the</span>
        <span class="ansi-red-fg"># main process won&#39;t send more tasks to this worker, and will send</span>
        <span class="ansi-red-fg"># `None` to this worker to properly exit it.</span>
        <span class="ansi-red-fg">#</span>
        <span class="ansi-red-fg"># Note that we cannot set `done_event` from a worker as it is shared</span>
        <span class="ansi-red-fg"># among all processes. Instead, we set the `iteration_end` flag to</span>
        <span class="ansi-red-fg"># signify that the iterator is exhausted. When either `done_event` or</span>
        <span class="ansi-red-fg"># `iteration_end` is set, we skip all processing step and just wait for</span>
        <span class="ansi-red-fg"># `None`.</span>
        iteration_end <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>

        watchdog <span class="ansi-blue-fg">=</span> ManagerWatchdog<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

        <span class="ansi-green-fg">while</span> watchdog<span class="ansi-blue-fg">.</span>is_alive<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
                r <span class="ansi-blue-fg">=</span> index_queue<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span>timeout<span class="ansi-blue-fg">=</span>MP_STATUS_CHECK_INTERVAL<span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">except</span> queue<span class="ansi-blue-fg">.</span>Empty<span class="ansi-blue-fg">:</span>
                <span class="ansi-green-fg">continue</span>
            <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>r<span class="ansi-blue-fg">,</span> _ResumeIteration<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
                <span class="ansi-red-fg"># Acknowledge the main process</span>
                data_queue<span class="ansi-blue-fg">.</span>put<span class="ansi-blue-fg">(</span>r<span class="ansi-blue-fg">)</span>
                iteration_end <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>
                <span class="ansi-red-fg"># Recreate the fetcher for worker-reuse policy</span>
                fetcher <span class="ansi-blue-fg">=</span> _DatasetKind<span class="ansi-blue-fg">.</span>create_fetcher<span class="ansi-blue-fg">(</span>
                    dataset_kind<span class="ansi-blue-fg">,</span> dataset<span class="ansi-blue-fg">,</span> auto_collation<span class="ansi-blue-fg">,</span> collate_fn<span class="ansi-blue-fg">,</span> drop_last<span class="ansi-blue-fg">)</span>
                <span class="ansi-green-fg">continue</span>
            <span class="ansi-green-fg">elif</span> r <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
                <span class="ansi-red-fg"># Received the final signal</span>
                <span class="ansi-green-fg">assert</span> done_event<span class="ansi-blue-fg">.</span>is_set<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">or</span> iteration_end
                <span class="ansi-green-fg">break</span>
            <span class="ansi-green-fg">elif</span> done_event<span class="ansi-blue-fg">.</span>is_set<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">or</span> iteration_end<span class="ansi-blue-fg">:</span>
                <span class="ansi-red-fg"># `done_event` is set. But I haven&#39;t received the final signal</span>
                <span class="ansi-red-fg"># (None) yet. I will keep continuing until get it, and skip the</span>
                <span class="ansi-red-fg"># processing steps.</span>
                <span class="ansi-green-fg">continue</span>
            idx<span class="ansi-blue-fg">,</span> index <span class="ansi-blue-fg">=</span> r
            data<span class="ansi-blue-fg">:</span> Union<span class="ansi-blue-fg">[</span>_IterableDatasetStopIteration<span class="ansi-blue-fg">,</span> ExceptionWrapper<span class="ansi-blue-fg">]</span>
            <span class="ansi-green-fg">if</span> init_exception <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
                data <span class="ansi-blue-fg">=</span> init_exception
                init_exception <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>
            <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
                <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
                    data <span class="ansi-blue-fg">=</span> fetcher<span class="ansi-blue-fg">.</span>fetch<span class="ansi-blue-fg">(</span>index<span class="ansi-blue-fg">)</span>
                <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
                    <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>e<span class="ansi-blue-fg">,</span> StopIteration<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">and</span> dataset_kind <span class="ansi-blue-fg">==</span> _DatasetKind<span class="ansi-blue-fg">.</span>Iterable<span class="ansi-blue-fg">:</span>
                        data <span class="ansi-blue-fg">=</span> _IterableDatasetStopIteration<span class="ansi-blue-fg">(</span>worker_id<span class="ansi-blue-fg">)</span>
                        <span class="ansi-red-fg"># Set `iteration_end`</span>
                        <span class="ansi-red-fg">#   (1) to save future `next(...)` calls, and</span>
                        <span class="ansi-red-fg">#   (2) to avoid sending multiple `_IterableDatasetStopIteration`s.</span>
                        iteration_end <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span>
                    <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
                        <span class="ansi-red-fg"># It is important that we don&#39;t store exc_info in a variable.</span>
                        <span class="ansi-red-fg"># `ExceptionWrapper` does the correct thing.</span>
                        <span class="ansi-red-fg"># See NOTE [ Python Traceback Reference Cycle Problem ]</span>
                        data <span class="ansi-blue-fg">=</span> ExceptionWrapper<span class="ansi-blue-fg">(</span>
                            where<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#34;in DataLoader worker process {}&#34;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>worker_id<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
            data_queue<span class="ansi-blue-fg">.</span>put<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>idx<span class="ansi-blue-fg">,</span> data<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">del</span> data<span class="ansi-blue-fg">,</span> idx<span class="ansi-blue-fg">,</span> index<span class="ansi-blue-fg">,</span> r  <span class="ansi-red-fg"># save memory</span>
    <span class="ansi-green-fg">except</span> KeyboardInterrupt<span class="ansi-blue-fg">:</span>
        <span class="ansi-red-fg"># Main process will raise KeyboardInterrupt anyways.</span>
        <span class="ansi-green-fg">pass</span>
    <span class="ansi-green-fg">if</span> done_event<span class="ansi-blue-fg">.</span>is_set<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        data_queue<span class="ansi-blue-fg">.</span>cancel_join_thread<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        data_queue<span class="ansi-blue-fg">.</span>close<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="n">Learner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.test_utils</span> <span class="kn">import</span> <span class="n">synth_learner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">synth_learner</span><span class="p">()</span><span class="o">.</span><span class="n">show_training_loop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Start Fit
   - before_fit     : [TrainEvalCallback, Recorder]
  Start Epoch Loop
     - before_epoch   : [Recorder]
    Start Train
       - before_train   : [TrainEvalCallback, Recorder]
      Start Batch Loop
         - before_batch   : []
         - after_pred     : []
         - after_loss     : []
         - before_backward: []
         - before_step    : []
         - after_step     : []
         - after_cancel_batch: []
         - after_batch    : [TrainEvalCallback, Recorder]
      End Batch Loop
    End Train
     - after_cancel_train: [Recorder]
     - after_train    : [Recorder]
    Start Valid
       - before_validate: [TrainEvalCallback, Recorder]
      Start Batch Loop
         - **CBs same as train batch**: []
      End Batch Loop
    End Valid
     - after_cancel_validate: [Recorder]
     - after_validate : [Recorder]
  End Epoch Loop
   - after_cancel_epoch: []
   - after_epoch    : [Recorder]
End Fit
 - after_cancel_fit: []
 - after_fit      : []
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>TestDataset<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre><span class="ansi-red-fg">Init signature:</span> TestDataset<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwds<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>     
An abstract class representing a :class:`Dataset`.

All datasets that represent a map from keys to data samples should subclass
it. All subclasses should overwrite :meth:`__getitem__`, supporting fetching a
data sample for a given key. Subclasses could also optionally overwrite
:meth:`__len__`, which is expected to return the size of the dataset by many
:class:`~torch.utils.data.Sampler` implementations and the default options
of :class:`~torch.utils.data.DataLoader`.

.. note::
  :class:`~torch.utils.data.DataLoader` by default constructs a index
  sampler that yields integral indices.  To make it work with a map-style
  dataset with non-integral indices/keys, a custom sampler must be provided.
<span class="ansi-red-fg">Source:</span>        
<span class="ansi-green-fg">class</span> TestDataset<span class="ansi-blue-fg">(</span>Dataset<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>policy<span class="ansi-blue-fg">,</span>device<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;cpu&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>policy<span class="ansi-blue-fg">=</span>policy
        self<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">=</span>device
        self<span class="ansi-blue-fg">.</span>policy<span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">)</span>

        self<span class="ansi-blue-fg">.</span>pids<span class="ansi-blue-fg">=</span>mp<span class="ansi-blue-fg">.</span>Queue<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>pids<span class="ansi-blue-fg">.</span>put<span class="ansi-blue-fg">(</span>os<span class="ansi-blue-fg">.</span>getpid<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>envs<span class="ansi-blue-fg">=</span>mp<span class="ansi-blue-fg">.</span>Queue<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>envs<span class="ansi-blue-fg">.</span>put<span class="ansi-blue-fg">(</span>os<span class="ansi-blue-fg">.</span>getpid<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

        self<span class="ansi-blue-fg">.</span>env<span class="ansi-blue-fg">=</span>gym<span class="ansi-blue-fg">.</span>make<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;CartPole-v1&#39;</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> __len__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> <span class="ansi-cyan-fg">100</span>
    <span class="ansi-green-fg">def</span> __getitem__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>idx<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>pids<span class="ansi-blue-fg">.</span>put<span class="ansi-blue-fg">(</span>os<span class="ansi-blue-fg">.</span>getpid<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>envs<span class="ansi-blue-fg">.</span>put<span class="ansi-blue-fg">(</span>id<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>env<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-red-fg">#             env=gym.make(&#39;CartPole-v1&#39;)</span>
            next_state<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>env<span class="ansi-blue-fg">.</span>reset<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
            print<span class="ansi-blue-fg">(</span>id<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>env<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">&#39; &#39;</span><span class="ansi-blue-fg">)</span>
            print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;pid is: &#39;</span><span class="ansi-blue-fg">,</span>os<span class="ansi-blue-fg">.</span>getpid<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>flush<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
            next_state<span class="ansi-blue-fg">,</span> r<span class="ansi-blue-fg">,</span> is_done<span class="ansi-blue-fg">,</span> _<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>env<span class="ansi-blue-fg">.</span>step<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>policy<span class="ansi-blue-fg">(</span>Tensor<span class="ansi-blue-fg">(</span>next_state<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>cpu<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>numpy<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">if</span> is_done<span class="ansi-blue-fg">:</span>next_state<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>env<span class="ansi-blue-fg">.</span>reset<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">return</span> Tensor<span class="ansi-blue-fg">(</span>next_state<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
            print<span class="ansi-blue-fg">(</span>e<span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">return</span> Tensor<span class="ansi-blue-fg">(</span>np<span class="ansi-blue-fg">.</span>random<span class="ansi-blue-fg">.</span>rand<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">4</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>           ~/fastrl/fastrl/data/block.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_THREADING_LAYER&#39;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;GNU&quot;</span>
    
    <span class="kn">import</span> <span class="nn">torch.multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
    <span class="k">try</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span><span class="k">pass</span>
    
    <span class="c1"># Third party libs</span>
    <span class="kn">from</span> <span class="nn">fastai.torch_basics</span> <span class="kn">import</span> <span class="o">*</span>
    <span class="kn">from</span> <span class="nn">fastai.data.all</span> <span class="kn">import</span> <span class="o">*</span>
    <span class="c1"># Local modules</span>
    <span class="kn">from</span> <span class="nn">fastrl.data.block</span> <span class="kn">import</span> <span class="o">*</span>
    <span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span>

    
    <span class="n">dqn</span><span class="o">=</span><span class="n">DQN</span><span class="p">()</span><span class="o">.</span><span class="n">share_memory</span><span class="p">()</span>
    <span class="n">opt</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">dqn</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">=</span><span class="n">TestDataset</span><span class="p">(</span><span class="n">dqn</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">default_device</span><span class="p">())</span>
    
    <span class="n">dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">out</span><span class="o">=</span><span class="n">dqn</span><span class="o">.</span><span class="n">policy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">target</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">loss</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()(</span><span class="n">out</span><span class="p">,</span><span class="n">target</span><span class="p">)</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">ds</span><span class="o">.</span><span class="n">pids</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pids</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">ds</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor([[ 0.0441,  0.1664,  0.0482, -0.3158],
        [ 0.0238,  0.2068, -0.0211, -0.2508],
        [ 0.0053,  0.1724,  0.0384, -0.2331],
        [-0.0118,  0.2236,  0.0053, -0.2778],
        [ 0.0426,  0.1874, -0.0471, -0.2632]])
tensor(0.8844, grad_fn=&lt;MseLossBackward&gt;)
tensor([[ 0.0441,  0.1664,  0.0482, -0.3158],
        [ 0.0238,  0.2068, -0.0211, -0.2508],
        [ 0.0053,  0.1724,  0.0384, -0.2331],
        [-0.0118,  0.2236,  0.0053, -0.2778],
        [ 0.0426,  0.1874, -0.0471, -0.2632]])
tensor(0.8049, grad_fn=&lt;MseLossBackward&gt;)
tensor([[-0.0353,  0.1899,  0.0222, -0.3078],
        [ 0.0056,  0.1533,  0.0337, -0.3161],
        [ 0.0202,  0.1772, -0.0246, -0.3179],
        [ 0.0058,  0.1980,  0.0412, -0.2539],
        [-0.0148,  0.2275, -0.0444, -0.3056]])
tensor(0.7305, grad_fn=&lt;MseLossBackward&gt;)
tensor([[ 0.0441,  0.1664,  0.0482, -0.3158],
        [ 0.0238,  0.2068, -0.0211, -0.2508],
        [ 0.0053,  0.1724,  0.0384, -0.2331],
        [-0.0118,  0.2236,  0.0053, -0.2778],
        [ 0.0426,  0.1874, -0.0471, -0.2632]])
tensor(0.6765, grad_fn=&lt;MseLossBackward&gt;)
tensor([[ 0.0441,  0.1664,  0.0482, -0.3158],
        [ 0.0238,  0.2068, -0.0211, -0.2508],
        [ 0.0053,  0.1724,  0.0384, -0.2331],
        [-0.0118,  0.2236,  0.0053, -0.2778],
        [ 0.0426,  0.1874, -0.0471, -0.2632]])
tensor(0.6269, grad_fn=&lt;MseLossBackward&gt;)
tensor([[-0.0353,  0.1899,  0.0222, -0.3078],
        [ 0.0056,  0.1533,  0.0337, -0.3161],
        [ 0.0202,  0.1772, -0.0246, -0.3179],
        [ 0.0058,  0.1980,  0.0412, -0.2539],
        [-0.0148,  0.2275, -0.0444, -0.3056]])
tensor(0.5819, grad_fn=&lt;MseLossBackward&gt;)
tensor([[ 0.0441,  0.1664,  0.0482, -0.3158],
        [ 0.0238,  0.2068, -0.0211, -0.2508],
        [ 0.0053,  0.1724,  0.0384, -0.2331],
        [-0.0118,  0.2236,  0.0053, -0.2778],
        [ 0.0426,  0.1874, -0.0471, -0.2632]])
tensor(0.5534, grad_fn=&lt;MseLossBackward&gt;)
tensor([[ 0.0441,  0.1664,  0.0482, -0.3158],
        [ 0.0238,  0.2068, -0.0211, -0.2508],
        [ 0.0053,  0.1724,  0.0384, -0.2331],
        [-0.0118,  0.2236,  0.0053, -0.2778],
        [ 0.0426,  0.1874, -0.0471, -0.2632]])
tensor(0.5289, grad_fn=&lt;MseLossBackward&gt;)
tensor([[-0.0353,  0.1899,  0.0222, -0.3078],
        [ 0.0056,  0.1533,  0.0337, -0.3161],
        [ 0.0202,  0.1772, -0.0246, -0.3179],
        [ 0.0058,  0.1980,  0.0412, -0.2539],
        [-0.0148,  0.2275, -0.0444, -0.3056]])
tensor(0.5105, grad_fn=&lt;MseLossBackward&gt;)
tensor([[ 0.0441,  0.1664,  0.0482, -0.3158],
        [ 0.0238,  0.2068, -0.0211, -0.2508],
        [ 0.0053,  0.1724,  0.0384, -0.2331],
        [-0.0118,  0.2236,  0.0053, -0.2778],
        [ 0.0426,  0.1874, -0.0471, -0.2632]])
tensor(0.5029, grad_fn=&lt;MseLossBackward&gt;)
tensor([[ 0.0441,  0.1664,  0.0482, -0.3158],
        [ 0.0238,  0.2068, -0.0211, -0.2508],
        [ 0.0053,  0.1724,  0.0384, -0.2331],
        [-0.0118,  0.2236,  0.0053, -0.2778],
        [ 0.0426,  0.1874, -0.0471, -0.2632]])
tensor(0.5002, grad_fn=&lt;MseLossBackward&gt;)
tensor([[-0.0353,  0.1899,  0.0222, -0.3078],
        [ 0.0056,  0.1533,  0.0337, -0.3161],
        [ 0.0202,  0.1772, -0.0246, -0.3179],
        [ 0.0058,  0.1980,  0.0412, -0.2539],
        [-0.0148,  0.2275, -0.0444, -0.3056]])
tensor(0.5037, grad_fn=&lt;MseLossBackward&gt;)
5104 5872 5872 5872 5872 5872 5872 5872 5872 5872 5872 5873 5873 5873 5873 5873 5911 5911 5911 5911 5911 5910 5910 5910 5910 5910 5910 5910 5910 5910 5910 5948 5948 5948 5949 5948 5948 5949 5949 5948 5949 5948 5949 5948 5948 5948 5986 5986 5986 5986 5986 5986 5986 5986 5986 5986 5987 5987 5987 5987 5987 5104 140111114378448 140111114378448 140111114378448 140111114378448 140111114378448 140111114378448 140111114378448 140111114378448 140111114378448 140111114378448 140519902260496 140519902260496 140519902260496 140519902260496 140519902260496 140189215718672 140189215718672 140189215718672 140189215718672 140189215718672 139732953607440 139732953607440 139732953607440 139732953607440 139732953607440 139732953607440 139732953607440 139732953607440 139732953607440 139732953607440 139722517531856 139722517531856 139722517531856 140237354114320 139722517531856 139722517531856 140237354114320 139722517531856 140237354114320 140237354114320 139722517531856 140237354114320 139722517531856 139722517531856 139722517531856 139896745520144 139896745520144 139896745520144 139896745520144 139896745520144 139896745520144 139896745520144 139896745520144 139896745520144 139896745520144 139716882521296 139716882521296 139716882521296 139716882521296 139716882521296 </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

