---

title: AgentLearner

keywords: fastai
sidebar: home_sidebar

summary: "Base for all RL learners"
description: "Base for all RL learners"
nb_path: "nbs/04_learner.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/04_learner.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>Learner<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre><span class="ansi-red-fg">Init signature:</span>
Learner<span class="ansi-blue-fg">(</span>
    dls<span class="ansi-blue-fg">,</span>
    model<span class="ansi-blue-fg">,</span>
    loss_func<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    opt_func<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&lt;</span>function Adam at <span class="ansi-cyan-fg">0x7f7f51c12b90</span><span class="ansi-blue-fg">&gt;</span><span class="ansi-blue-fg">,</span>
    lr<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.001</span><span class="ansi-blue-fg">,</span>
    splitter<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&lt;</span>function trainable_params at <span class="ansi-cyan-fg">0x7f7f53f80320</span><span class="ansi-blue-fg">&gt;</span><span class="ansi-blue-fg">,</span>
    cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    metrics<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    path<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    model_dir<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;models&#39;</span><span class="ansi-blue-fg">,</span>
    wd<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    wd_bn_bias<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    train_bn<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    moms<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0.95</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0.85</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0.95</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      Group together a `model`, some `dls` and a `loss_func` to handle training
<span class="ansi-red-fg">Source:</span>        
<span class="ansi-green-fg">class</span> Learner<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> dls<span class="ansi-blue-fg">,</span> model<span class="ansi-blue-fg">,</span> loss_func<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> opt_func<span class="ansi-blue-fg">=</span>Adam<span class="ansi-blue-fg">,</span> lr<span class="ansi-blue-fg">=</span>defaults<span class="ansi-blue-fg">.</span>lr<span class="ansi-blue-fg">,</span> splitter<span class="ansi-blue-fg">=</span>trainable_params<span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
                 metrics<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> path<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> model_dir<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;models&#39;</span><span class="ansi-blue-fg">,</span> wd<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> wd_bn_bias<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> train_bn<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
                 moms<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0.95</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">0.85</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">0.95</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        store_attr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;dls,model,opt_func,lr,splitter,model_dir,wd,wd_bn_bias,train_bn,metrics,moms&#34;</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>training<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>create_mbar<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>logger<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>cbs <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>print<span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>L<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> loss_func <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
            loss_func <span class="ansi-blue-fg">=</span> getattr<span class="ansi-blue-fg">(</span>dls<span class="ansi-blue-fg">.</span>train_ds<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;loss_func&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">assert</span> loss_func <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#34;Could not infer loss function from the data, please pass a loss function.&#34;</span>
        self<span class="ansi-blue-fg">.</span>loss_func <span class="ansi-blue-fg">=</span> loss_func
        self<span class="ansi-blue-fg">.</span>path <span class="ansi-blue-fg">=</span> Path<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> path <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span> <span class="ansi-green-fg">else</span> getattr<span class="ansi-blue-fg">(</span>dls<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;path&#39;</span><span class="ansi-blue-fg">,</span> Path<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;.&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>add_cbs<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">,</span> type<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">else</span> cb<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">for</span> cb <span class="ansi-green-fg">in</span> L<span class="ansi-blue-fg">(</span>defaults<span class="ansi-blue-fg">.</span>callbacks<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">+</span>L<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>epoch<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>n_epoch<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>loss <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span>tensor<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0.</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-blue-fg">@</span>property
    <span class="ansi-green-fg">def</span> metrics<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_metrics
    <span class="ansi-blue-fg">@</span>metrics<span class="ansi-blue-fg">.</span>setter
    <span class="ansi-green-fg">def</span> metrics<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>v<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>_metrics <span class="ansi-blue-fg">=</span> L<span class="ansi-blue-fg">(</span>v<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>map<span class="ansi-blue-fg">(</span>mk_metric<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _grab_cbs<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cb_cls<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> L<span class="ansi-blue-fg">(</span>cb <span class="ansi-green-fg">for</span> cb <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>cbs <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">,</span> cb_cls<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> add_cbs<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> L<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>map<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>add_cb<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> remove_cbs<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> L<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>map<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>remove_cb<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> add_cb<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        old <span class="ansi-blue-fg">=</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cb<span class="ansi-blue-fg">.</span>name<span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">assert</span> <span class="ansi-green-fg">not</span> old <span class="ansi-green-fg">or</span> isinstance<span class="ansi-blue-fg">(</span>old<span class="ansi-blue-fg">,</span> type<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">f&#34;self.{cb.name} already registered&#34;</span>
        cb<span class="ansi-blue-fg">.</span>learn <span class="ansi-blue-fg">=</span> self
        setattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cb<span class="ansi-blue-fg">.</span>name<span class="ansi-blue-fg">,</span> cb<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>cbs<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> self

    <span class="ansi-green-fg">def</span> remove_cb<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">,</span> type<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>remove_cbs<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_grab_cbs<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
            cb<span class="ansi-blue-fg">.</span>learn <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>
            <span class="ansi-green-fg">if</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cb<span class="ansi-blue-fg">.</span>name<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> delattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cb<span class="ansi-blue-fg">.</span>name<span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">if</span> cb <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>cbs<span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>cbs<span class="ansi-blue-fg">.</span>remove<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">)</span>

    <span class="ansi-blue-fg">@</span>contextmanager
    <span class="ansi-green-fg">def</span> added_cbs<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>add_cbs<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">yield</span>
        <span class="ansi-green-fg">finally</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>remove_cbs<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span>

    <span class="ansi-blue-fg">@</span>contextmanager
    <span class="ansi-green-fg">def</span> removed_cbs<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>remove_cbs<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">yield</span> self
        <span class="ansi-green-fg">finally</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>add_cbs<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> ordered_cbs<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> event<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> <span class="ansi-blue-fg">[</span>cb <span class="ansi-green-fg">for</span> cb <span class="ansi-green-fg">in</span> sort_by_run<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>cbs<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> hasattr<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">,</span> event<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span>

    <span class="ansi-green-fg">def</span> __call__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> event_name<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> L<span class="ansi-blue-fg">(</span>event_name<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>map<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_call_one<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _call_one<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> event_name<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">assert</span> hasattr<span class="ansi-blue-fg">(</span>event<span class="ansi-blue-fg">,</span> event_name<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> event_name
        <span class="ansi-blue-fg">[</span>cb<span class="ansi-blue-fg">(</span>event_name<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">for</span> cb <span class="ansi-green-fg">in</span> sort_by_run<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span>

    <span class="ansi-green-fg">def</span> _bn_bias_state<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> with_bias<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> norm_bias_params<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>model<span class="ansi-blue-fg">,</span> with_bias<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>map<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">.</span>state<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> create_opt<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>opt <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>opt_func<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>splitter<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>model<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> lr<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>lr<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>wd_bn_bias<span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">for</span> p <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>_bn_bias_state<span class="ansi-blue-fg">(</span><span class="ansi-green-fg">True</span> <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> p<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;do_wd&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span>
        <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>train_bn<span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">for</span> p <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>_bn_bias_state<span class="ansi-blue-fg">(</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> p<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;force_train&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span>

    <span class="ansi-green-fg">def</span> _split<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        i <span class="ansi-blue-fg">=</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;n_inp&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">1</span> <span class="ansi-green-fg">if</span> len<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">==</span><span class="ansi-cyan-fg">1</span> <span class="ansi-green-fg">else</span> len<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>xb<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>yb <span class="ansi-blue-fg">=</span> b<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>b<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span>

    <span class="ansi-green-fg">def</span> _step<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">.</span>step<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _backward<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>loss<span class="ansi-blue-fg">.</span>backward<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> f<span class="ansi-blue-fg">,</span> event_type<span class="ansi-blue-fg">,</span> ex<span class="ansi-blue-fg">,</span> final<span class="ansi-blue-fg">=</span>noop<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>       self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;before_{event_type}&#39;</span><span class="ansi-blue-fg">)</span>       <span class="ansi-blue-fg">;</span>f<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">except</span> ex<span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;after_cancel_{event_type}&#39;</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">finally</span><span class="ansi-blue-fg">:</span>   self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;after_{event_type}&#39;</span><span class="ansi-blue-fg">)</span>        <span class="ansi-blue-fg">;</span>final<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> all_batches<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>n_iter <span class="ansi-blue-fg">=</span> len<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dl<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> enumerate<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dl<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>one_batch<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>o<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _do_one_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>pred <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>model<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>self<span class="ansi-blue-fg">.</span>xb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>                self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_pred&#39;</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> len<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>yb<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">==</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span>
        self<span class="ansi-blue-fg">.</span>loss <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>loss_func<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>pred<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>self<span class="ansi-blue-fg">.</span>yb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_loss&#39;</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>training<span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span>
        self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;before_backward&#39;</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_backward<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>                                self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_backward&#39;</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_step<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>                                    self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_step&#39;</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">.</span>zero_grad<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> one_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> i<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>iter <span class="ansi-blue-fg">=</span> i
        self<span class="ansi-blue-fg">.</span>_split<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_do_one_batch<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;batch&#39;</span><span class="ansi-blue-fg">,</span> CancelBatchException<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _do_epoch_train<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>dl <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">.</span>train
        self<span class="ansi-blue-fg">.</span>_with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>all_batches<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;train&#39;</span><span class="ansi-blue-fg">,</span> CancelTrainException<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _do_epoch_validate<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> ds_idx<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> dl<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> dl <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> dl <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">[</span>ds_idx<span class="ansi-blue-fg">]</span>
        self<span class="ansi-blue-fg">.</span>dl <span class="ansi-blue-fg">=</span> dl<span class="ansi-blue-fg">;</span>
        <span class="ansi-green-fg">with</span> torch<span class="ansi-blue-fg">.</span>no_grad<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>_with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>all_batches<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;validate&#39;</span><span class="ansi-blue-fg">,</span> CancelValidException<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _do_epoch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>_do_epoch_train<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_do_epoch_validate<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _do_fit<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">for</span> epoch <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>n_epoch<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            self<span class="ansi-blue-fg">.</span>epoch<span class="ansi-blue-fg">=</span>epoch
            self<span class="ansi-blue-fg">.</span>_with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_do_epoch<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;epoch&#39;</span><span class="ansi-blue-fg">,</span> CancelEpochException<span class="ansi-blue-fg">)</span>

    <span class="ansi-blue-fg">@</span>log_args<span class="ansi-blue-fg">(</span>but<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;cbs&#39;</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> fit<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> n_epoch<span class="ansi-blue-fg">,</span> lr<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> wd<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> reset_opt<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">with</span> self<span class="ansi-blue-fg">.</span>added_cbs<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">if</span> reset_opt <span class="ansi-green-fg">or</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>create_opt<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">if</span> wd <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> wd <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>wd
            <span class="ansi-green-fg">if</span> wd <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">.</span>set_hypers<span class="ansi-blue-fg">(</span>wd<span class="ansi-blue-fg">=</span>wd<span class="ansi-blue-fg">)</span>
            self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">.</span>set_hypers<span class="ansi-blue-fg">(</span>lr<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>lr <span class="ansi-green-fg">if</span> lr <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span> <span class="ansi-green-fg">else</span> lr<span class="ansi-blue-fg">)</span>
            self<span class="ansi-blue-fg">.</span>n_epoch<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>loss <span class="ansi-blue-fg">=</span> n_epoch<span class="ansi-blue-fg">,</span>tensor<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0.</span><span class="ansi-blue-fg">)</span>
            self<span class="ansi-blue-fg">.</span>_with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_do_fit<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;fit&#39;</span><span class="ansi-blue-fg">,</span> CancelFitException<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>_end_cleanup<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> _end_cleanup<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>dl<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>xb<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>yb<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>pred<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>loss <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">(</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">(</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span>
    <span class="ansi-green-fg">def</span> __enter__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span>_before_epoch<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span> <span class="ansi-green-fg">return</span> self
    <span class="ansi-green-fg">def</span> __exit__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> exc_type<span class="ansi-blue-fg">,</span> exc_value<span class="ansi-blue-fg">,</span> tb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span>_after_epoch<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> validation_context<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> inner<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        cms <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>self<span class="ansi-blue-fg">.</span>no_logging<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>no_mbar<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span>
        <span class="ansi-green-fg">if</span> cbs<span class="ansi-blue-fg">:</span> cms<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>added_cbs<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> inner<span class="ansi-blue-fg">:</span> cms<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> ContextManagers<span class="ansi-blue-fg">(</span>cms<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> validate<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> ds_idx<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> dl<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> dl <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> dl <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">[</span>ds_idx<span class="ansi-blue-fg">]</span>
        <span class="ansi-green-fg">with</span> self<span class="ansi-blue-fg">.</span>validation_context<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">=</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>_do_epoch_validate<span class="ansi-blue-fg">(</span>ds_idx<span class="ansi-blue-fg">,</span> dl<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;final_record&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-blue-fg">@</span>delegates<span class="ansi-blue-fg">(</span>GatherPredsCallback<span class="ansi-blue-fg">.</span>__init__<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> get_preds<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> ds_idx<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> dl<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> with_input<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> with_decoded<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> with_loss<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> act<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
                  inner<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> reorder<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> dl <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> dl <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">[</span>ds_idx<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>new<span class="ansi-blue-fg">(</span>shuffled<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> drop_last<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> reorder <span class="ansi-green-fg">and</span> hasattr<span class="ansi-blue-fg">(</span>dl<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;get_idxs&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            idxs <span class="ansi-blue-fg">=</span> dl<span class="ansi-blue-fg">.</span>get_idxs<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
            dl <span class="ansi-blue-fg">=</span> dl<span class="ansi-blue-fg">.</span>new<span class="ansi-blue-fg">(</span>get_idxs <span class="ansi-blue-fg">=</span> _ConstantFunc<span class="ansi-blue-fg">(</span>idxs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        cb <span class="ansi-blue-fg">=</span> GatherPredsCallback<span class="ansi-blue-fg">(</span>with_input<span class="ansi-blue-fg">=</span>with_input<span class="ansi-blue-fg">,</span> with_loss<span class="ansi-blue-fg">=</span>with_loss<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
        ctx_mgrs <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>validation_context<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">=</span>L<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">+</span><span class="ansi-blue-fg">[</span>cb<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> inner<span class="ansi-blue-fg">=</span>inner<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> with_loss<span class="ansi-blue-fg">:</span> ctx_mgrs<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>loss_not_reduced<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">with</span> ContextManagers<span class="ansi-blue-fg">(</span>ctx_mgrs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            self<span class="ansi-blue-fg">.</span>_do_epoch_validate<span class="ansi-blue-fg">(</span>dl<span class="ansi-blue-fg">=</span>dl<span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">if</span> act <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> act <span class="ansi-blue-fg">=</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>loss_func<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;activation&#39;</span><span class="ansi-blue-fg">,</span> noop<span class="ansi-blue-fg">)</span>
            res <span class="ansi-blue-fg">=</span> cb<span class="ansi-blue-fg">.</span>all_tensors<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
            pred_i <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">1</span> <span class="ansi-green-fg">if</span> with_input <span class="ansi-green-fg">else</span> <span class="ansi-cyan-fg">0</span>
            <span class="ansi-green-fg">if</span> res<span class="ansi-blue-fg">[</span>pred_i<span class="ansi-blue-fg">]</span> <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
                res<span class="ansi-blue-fg">[</span>pred_i<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> act<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">[</span>pred_i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
                <span class="ansi-green-fg">if</span> with_decoded<span class="ansi-blue-fg">:</span> res<span class="ansi-blue-fg">.</span>insert<span class="ansi-blue-fg">(</span>pred_i<span class="ansi-blue-fg">+</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">,</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>loss_func<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;decodes&#39;</span><span class="ansi-blue-fg">,</span> noop<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">[</span>pred_i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">if</span> reorder <span class="ansi-green-fg">and</span> hasattr<span class="ansi-blue-fg">(</span>dl<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;get_idxs&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> res <span class="ansi-blue-fg">=</span> nested_reorder<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">,</span> tensor<span class="ansi-blue-fg">(</span>idxs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>argsort<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">return</span> tuple<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_end_cleanup<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> predict<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> item<span class="ansi-blue-fg">,</span> rm_type_tfms<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> with_input<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        dl <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">.</span>test_dl<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span>item<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> rm_type_tfms<span class="ansi-blue-fg">=</span>rm_type_tfms<span class="ansi-blue-fg">,</span> num_workers<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span>
        inp<span class="ansi-blue-fg">,</span>preds<span class="ansi-blue-fg">,</span>_<span class="ansi-blue-fg">,</span>dec_preds <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>get_preds<span class="ansi-blue-fg">(</span>dl<span class="ansi-blue-fg">=</span>dl<span class="ansi-blue-fg">,</span> with_input<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> with_decoded<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
        i <span class="ansi-blue-fg">=</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;n_inp&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
        inp <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>inp<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> i<span class="ansi-blue-fg">==</span><span class="ansi-cyan-fg">1</span> <span class="ansi-green-fg">else</span> tuplify<span class="ansi-blue-fg">(</span>inp<span class="ansi-blue-fg">)</span>
        dec <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">.</span>decode_batch<span class="ansi-blue-fg">(</span>inp <span class="ansi-blue-fg">+</span> tuplify<span class="ansi-blue-fg">(</span>dec_preds<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>
        dec_inp<span class="ansi-blue-fg">,</span>dec_targ <span class="ansi-blue-fg">=</span> map<span class="ansi-blue-fg">(</span>detuplify<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">[</span>dec<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>dec<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
        res <span class="ansi-blue-fg">=</span> dec_targ<span class="ansi-blue-fg">,</span>dec_preds<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>preds<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>
        <span class="ansi-green-fg">if</span> with_input<span class="ansi-blue-fg">:</span> res <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>dec_inp<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">+</span> res
        <span class="ansi-green-fg">return</span> res

    <span class="ansi-green-fg">def</span> show_results<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> ds_idx<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> dl<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">9</span><span class="ansi-blue-fg">,</span> shuffle<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> dl <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> dl <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">[</span>ds_idx<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>new<span class="ansi-blue-fg">(</span>shuffle<span class="ansi-blue-fg">=</span>shuffle<span class="ansi-blue-fg">)</span>
        b <span class="ansi-blue-fg">=</span> dl<span class="ansi-blue-fg">.</span>one_batch<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        _<span class="ansi-blue-fg">,</span>_<span class="ansi-blue-fg">,</span>preds <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>get_preds<span class="ansi-blue-fg">(</span>dl<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span>b<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> with_decoded<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">.</span>show_results<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> preds<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span>max_n<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">def</span> show_training_loop<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        indent <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span>
        <span class="ansi-green-fg">for</span> s <span class="ansi-green-fg">in</span> _loop<span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">if</span> s<span class="ansi-blue-fg">.</span>startswith<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Start&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;{&#34; &#34;*indent}{s}&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span> indent <span class="ansi-blue-fg">+=</span> <span class="ansi-cyan-fg">2</span>
            <span class="ansi-green-fg">elif</span> s<span class="ansi-blue-fg">.</span>startswith<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;End&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> indent <span class="ansi-blue-fg">-=</span> <span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">;</span> print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;{&#34; &#34;*indent}{s}&#39;</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span> print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;{&#34; &#34;*indent} - {s:15}:&#39;</span><span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>ordered_cbs<span class="ansi-blue-fg">(</span>s<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-blue-fg">@</span>contextmanager
    <span class="ansi-green-fg">def</span> no_logging<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> replacing_yield<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;logger&#39;</span><span class="ansi-blue-fg">,</span> noop<span class="ansi-blue-fg">)</span>
    <span class="ansi-blue-fg">@</span>contextmanager
    <span class="ansi-green-fg">def</span> no_mbar<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>    <span class="ansi-green-fg">return</span> replacing_yield<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;create_mbar&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-blue-fg">@</span>contextmanager
    <span class="ansi-green-fg">def</span> loss_not_reduced<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>loss_func<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;reduction&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> replacing_yield<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>loss_func<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;reduction&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;none&#39;</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> replacing_yield<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;loss_func&#39;</span><span class="ansi-blue-fg">,</span> partial<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>loss_func<span class="ansi-blue-fg">,</span> reduction<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;none&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-blue-fg">@</span>delegates<span class="ansi-blue-fg">(</span>save_model<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> save<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> file<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        file <span class="ansi-blue-fg">=</span> join_path_file<span class="ansi-blue-fg">(</span>file<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>path<span class="ansi-blue-fg">/</span>self<span class="ansi-blue-fg">.</span>model_dir<span class="ansi-blue-fg">,</span> ext<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;.pth&#39;</span><span class="ansi-blue-fg">)</span>
        save_model<span class="ansi-blue-fg">(</span>file<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>model<span class="ansi-blue-fg">,</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">&#39;opt&#39;</span><span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> file

    <span class="ansi-blue-fg">@</span>delegates<span class="ansi-blue-fg">(</span>load_model<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> load<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> file<span class="ansi-blue-fg">,</span> with_opt<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> device <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span> <span class="ansi-green-fg">and</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;device&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> device <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">.</span>device
        <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>opt <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>create_opt<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        file <span class="ansi-blue-fg">=</span> join_path_file<span class="ansi-blue-fg">(</span>file<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>path<span class="ansi-blue-fg">/</span>self<span class="ansi-blue-fg">.</span>model_dir<span class="ansi-blue-fg">,</span> ext<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;.pth&#39;</span><span class="ansi-blue-fg">)</span>
        load_model<span class="ansi-blue-fg">(</span>file<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>model<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span>device<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> self
<span class="ansi-red-fg">File:</span>           /opt/conda/envs/fastrl/lib/python3.7/site-packages/fastai/learner.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     AgentLearner
</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AgentLearner" class="doc_header"><code>class</code> <code>AgentLearner</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/learner.py#L22" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AgentLearner</code>(<strong><code>dls</code></strong>, <strong><code>agent</code></strong>:<a href="/fastrl/basic_agents.html#BaseAgent"><code>BaseAgent</code></a>=<em><code>BaseAgent(model=None)</code></em>, <strong><code>model</code></strong>=<em><code>None</code></em>, <strong><code>use_train_mets</code></strong>=<em><code>True</code></em>, <strong><code>loss_func</code></strong>=<em><code>None</code></em>, <strong><code>opt_func</code></strong>=<em><code>Adam</code></em>, <strong><code>lr</code></strong>=<em><code>0.001</code></em>, <strong><code>splitter</code></strong>=<em><code>trainable_params</code></em>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>None</code></em>, <strong><code>model_dir</code></strong>=<em><code>'models'</code></em>, <strong><code>wd</code></strong>=<em><code>None</code></em>, <strong><code>wd_bn_bias</code></strong>=<em><code>False</code></em>, <strong><code>train_bn</code></strong>=<em><code>True</code></em>, <strong><code>moms</code></strong>=<em><code>(0.95, 0.85, 0.95)</code></em>) :: <code>Learner</code></p>
</blockquote>
<p>Group together a <code>model</code>, some <code>dls</code> and a <a href="/fastrl/a3c.a3c_data.html#loss_func"><code>loss_func</code></a> to handle training</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

